


import pandas as pd
from sqlalchemy import create_engine
import os
import sys
from dotenv import load_dotenv
# Adicionar o diret√≥rio raiz ao path
current_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.dirname(os.path.dirname(os.path.dirname(current_dir)))
sys.path.insert(0, project_root)

from src.utils.naming_conventions import NamingConventions
from src.validation.data_validator import validate_dimension_data, get_validation_summary
from src.core.exceptions import DimensionCreationError, DataValidationError


# Adicionar diret√≥rio raiz ao path para imports
current_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.dirname(os.path.dirname(os.path.dirname(current_dir)))
sys.path.insert(0, project_root)

from src.core.core import salvar_df_bd

# Carregar vari√°veis de ambiente
load_dotenv()

DB_HOST = os.getenv("DB_HOST")
DB_NAME = os.getenv("DB_NAME")
DB_USER = os.getenv("DB_USER")
DB_PASS = os.getenv("DB_PASS")
DB_PORT = os.getenv("DB_PORT")

def extrair_dados_ods():
    """
    Extrai dados dos 17 Objetivos de Desenvolvimento Sustent√°vel (ODS) da ONU.
    """
    print("üéØ Extraindo dados dos ODS (Objetivos de Desenvolvimento Sustent√°vel)...")
    
    try:
        # Dados dos 17 ODS da ONU com temas relacionados
        ods_data = [
            (1, "Erradica√ß√£o da pobreza", "Acabar com a pobreza em todas as suas formas, em todos os lugares.", "pobreza extrema, renda, vulnerabilidade social, prote√ß√£o social, acesso a servi√ßos b√°sicos"),
            (2, "Fome zero e agricultura sustent√°vel", "Acabar com a fome, alcan√ßar a seguran√ßa alimentar e melhorar a nutri√ß√£o e promover a agricultura sustent√°vel.", "seguran√ßa alimentar, nutri√ß√£o, agricultura familiar, produtividade agr√≠cola, sistemas alimentares sustent√°veis"),
            (3, "Sa√∫de e bem-estar", "Assegurar uma vida saud√°vel e promover o bem-estar para todos, em todas as idades.", "mortalidade materno-infantil, doen√ßas transmiss√≠veis, sa√∫de mental, cobertura universal, acesso a medicamentos"),
            (4, "Educa√ß√£o de qualidade", "Assegurar a educa√ß√£o inclusiva e equitativa e de qualidade, e promover oportunidades de aprendizagem ao longo da vida para todos.", "educa√ß√£o b√°sica, alfabetiza√ß√£o, ensino superior, forma√ß√£o t√©cnica, igualdade de acesso educacional"),
            (5, "Igualdade de g√™nero", "Alcan√ßar a igualdade de g√™nero e empoderar todas as mulheres e meninas.", "empoderamento feminino, viol√™ncia de g√™nero, participa√ß√£o pol√≠tica, direitos reprodutivos, lideran√ßa feminina"),
            (6, "√Ågua pot√°vel e saneamento", "Assegurar a disponibilidade e gest√£o sustent√°vel da √°gua e saneamento para todos.", "acesso √† √°gua pot√°vel, saneamento b√°sico, gest√£o de recursos h√≠dricos, qualidade da √°gua, higiene"),
            (7, "Energia limpa e acess√≠vel", "Assegurar o acesso confi√°vel, sustent√°vel, moderno e a pre√ßo acess√≠vel √† energia para todos.", "energias renov√°veis, efici√™ncia energ√©tica, acesso universal √† energia, matriz energ√©tica limpa, tecnologias sustent√°veis"),
            (8, "Trabalho decente e crescimento econ√¥mico", "Promover o crescimento econ√¥mico sustentado, inclusivo e sustent√°vel, emprego pleno e produtivo e trabalho decente para todos.", "emprego pleno, trabalho decente, crescimento econ√¥mico, produtividade, empreendedorismo, direitos trabalhistas"),
            (9, "Ind√∫stria, inova√ß√£o e infraestrutura", "Construir infraestruturas resilientes, promover a industrializa√ß√£o inclusiva e sustent√°vel e fomentar a inova√ß√£o.", "infraestrutura resiliente, industrializa√ß√£o sustent√°vel, inova√ß√£o tecnol√≥gica, pesquisa e desenvolvimento, conectividade"),
            (10, "Redu√ß√£o das desigualdades", "Reduzir a desigualdade dentro dos pa√≠ses e entre eles.", "desigualdade de renda, inclus√£o social, migra√ß√£o segura, pol√≠ticas redistributivas, discrimina√ß√£o"),
            (11, "Cidades e comunidades sustent√°veis", "Tornar as cidades e os assentamentos humanos inclusivos, seguros, resilientes e sustent√°veis.", "urbaniza√ß√£o sustent√°vel, habita√ß√£o adequada, transporte p√∫blico, gest√£o de res√≠duos, planejamento urbano, patrim√¥nio cultural"),
            (12, "Consumo e produ√ß√£o respons√°veis", "Assegurar padr√µes de produ√ß√£o e de consumo sustent√°veis.", "efici√™ncia de recursos, economia circular, gest√£o de res√≠duos, sustentabilidade corporativa, consumo consciente"),
            (13, "A√ß√£o contra a mudan√ßa global do clima", "Tomar medidas urgentes para combater a mudan√ßa clim√°tica e seus impactos.", "mitiga√ß√£o clim√°tica, adapta√ß√£o √†s mudan√ßas clim√°ticas, emiss√µes de gases do efeito estufa, resili√™ncia clim√°tica, financiamento clim√°tico"),
            (14, "Vida na √°gua", "Conservar e usar sustentavelmente os oceanos, os mares e os recursos marinhos para o desenvolvimento sustent√°vel.", "conserva√ß√£o marinha, pesca sustent√°vel, polui√ß√£o oce√¢nica, ecossistemas aqu√°ticos, acidifica√ß√£o dos oceanos"),
            (15, "Vida terrestre", "Proteger, recuperar e promover o uso sustent√°vel dos ecossistemas terrestres.", "biodiversidade, desertifica√ß√£o, gest√£o florestal sustent√°vel, conserva√ß√£o de habitats, esp√©cies amea√ßadas"),
            (16, "Paz, justi√ßa e institui√ß√µes eficazes", "Promover sociedades pac√≠ficas e inclusivas para o desenvolvimento sustent√°vel.", "estado de direito, justi√ßa, transpar√™ncia, corrup√ß√£o, institui√ß√µes eficazes, acesso √† justi√ßa"),
            (17, "Parcerias e meios de implementa√ß√£o", "Fortalecer os meios de implementa√ß√£o e revitalizar a parceria global para o desenvolvimento sustent√°vel.", "coopera√ß√£o internacional, financiamento, transfer√™ncia de tecnologia, capacita√ß√£o, parcerias multissetoriais")
        ]
        
        # Converter para DataFrame
        df_ods = pd.DataFrame(ods_data, columns=["ods_numero", "ods_nome", "ods_descricao", "ods_temas_relacionados"])
        
        # Tratar e limpar dados
        df_ods = tratar_dados_ods(df_ods)
        
        print(f"‚úÖ Dados dos ODS extra√≠dos: {len(df_ods)} registros")
        
        return df_ods
        
    except Exception as e:
        print(f"‚ùå Erro ao extrair dados dos ODS: {e}")
        return pd.DataFrame()

def tratar_dados_ods(df_ods):
    """
    Trata e limpa os dados dos ODS.
    """
    try:
        # Normalizar textos
        df_ods['ods_nome'] = df_ods['ods_nome'].str.strip().str.title()
        df_ods['ods_descricao'] = df_ods['ods_descricao'].str.strip()
        
        # Adicionar campos auxiliares
        df_ods['ods_codigo'] = 'ODS-' + df_ods['ods_numero'].astype(str).str.zfill(2)
        df_ods['ods_status'] = 'Ativo'
        df_ods['ods_categoria'] = df_ods['ods_numero'].apply(categorizar_ods)
        
        # Adicionar registro SK=0 (desconhecido/n√£o aplic√°vel)
        registro_sk0 = create_sk0_record()
        df_ods = pd.concat([registro_sk0, df_ods], ignore_index=True)
        
        # Adicionar surrogate key (come√ßando do 0)
        df_ods.insert(0, 'ods_sk', range(0, len(df_ods)))
        
        return df_ods
        
    except Exception as e:
        print(f"‚ùå Erro ao tratar dados dos ODS: {e}")
        return df_ods

def categorizar_ods(numero):
    """
    Categoriza os ODS em grupos tem√°ticos.
    """
    categorias = {
        1: 'Social',      # Erradica√ß√£o da pobreza
        2: 'Ambiental',   # Fome zero
        3: 'Social',      # Sa√∫de e bem-estar
        4: 'Social',      # Educa√ß√£o de qualidade
        5: 'Social',      # Igualdade de g√™nero
        6: 'Ambiental',   # √Ågua pot√°vel
        7: 'Ambiental',   # Energia limpa
        8: 'Econ√¥mico',   # Trabalho decente
        9: 'Econ√¥mico',   # Ind√∫stria e inova√ß√£o
        10: 'Social',     # Redu√ß√£o das desigualdades
        11: 'Ambiental',  # Cidades sustent√°veis
        12: 'Ambiental',  # Consumo respons√°vel
        13: 'Ambiental',  # A√ß√£o clim√°tica
        14: 'Ambiental',  # Vida na √°gua
        15: 'Ambiental',  # Vida terrestre
        16: 'Governan√ßa', # Paz e justi√ßa
        17: 'Governan√ßa'  # Parcerias
    }
    return categorias.get(numero, 'Geral')

def create_sk0_record():
    """
    Cria o registro SK=0 para valores desconhecidos/n√£o aplic√°veis.
    """
    registro_sk0 = {
        'ods_numero': 0,
        'ods_nome': 'DESCONHECIDO',
        'ods_descricao': 'Registro para valores desconhecidos ou n√£o aplic√°veis',
        'ods_temas_relacionados': 'DESCONHECIDO',
        'ods_codigo': 'ODS-00',
        'ods_status': 'DESCONHECIDO',
        'ods_categoria': 'DESCONHECIDO'
    }
    
    return pd.DataFrame([registro_sk0])

def salvar_dimensao_ods(df_ods):
    """
    Salva a dimens√£o ODS no banco de dados PostgreSQL.
    """
    try:
        # Criar conex√£o com o banco
        from sqlalchemy import create_engine
        import os
        from dotenv import load_dotenv
        
        load_dotenv()
        DB_HOST = os.getenv("DB_HOST")
        DB_NAME = os.getenv("DB_NAME")
        DB_USER = os.getenv("DB_USER")
        DB_PASS = os.getenv("DB_PASS")
        DB_PORT = os.getenv("DB_PORT")
        
        url = f'postgresql+psycopg2://{DB_USER}:{DB_PASS}@{DB_HOST}:{DB_PORT}/{DB_NAME}'
        engine = create_engine(url)
        
        with engine.begin() as conn:
            # Primeiro criar a tabela com estrutura expl√≠cita
            create_table_sql = """
            CREATE TABLE IF NOT EXISTS dim_ods (
                ods_sk INTEGER PRIMARY KEY,
                ods_numero INTEGER NOT NULL,
                ods_nome VARCHAR(255) NOT NULL,
                ods_descricao TEXT,
                ods_temas_relacionados TEXT,
                ods_codigo VARCHAR(20) NOT NULL,
                ods_status VARCHAR(50),
                ods_categoria VARCHAR(50)
            );
            """
            
            # Executar a cria√ß√£o da tabela
            conn.exec_driver_sql(create_table_sql)
            
            # Limpar tabela se j√° existir dados
            conn.exec_driver_sql("DELETE FROM dim_ods;")
            
            # Inserir dados
            df_ods.to_sql('dim_ods', conn, if_exists='append', index=False)
        print(f"‚úÖ Dimens√£o ODS salva no PostgreSQL com {len(df_ods)} registros")
            
    except Exception as e:
        print(f"‚ùå Erro ao salvar dimens√£o ODS: {e}")

if __name__ == "__main__":
    print("üöÄ Iniciando processo de cria√ß√£o da dimens√£o ODS")
    print("üéØ Fonte de dados: Objetivos de Desenvolvimento Sustent√°vel da ONU")
    
    # Extrair dados dos ODS
    df_ods = extrair_dados_ods()
    
    if df_ods.empty:
        print("‚ùå Nenhum dado foi retornado. Encerrando o script.")
        exit(1)
    
    # Salvar no banco
    salvar_dimensao_ods(df_ods)
    
    # Mostrar algumas estat√≠sticas
    print("\nüìä Estat√≠sticas da dimens√£o ODS:")
    print(f"Total de ODS: {len(df_ods)}")
    
    if 'ods_categoria' in df_ods.columns:
        print(f"\nODS por categoria:")
        for categoria in sorted(df_ods['ods_categoria'].unique()):
            count = len(df_ods[df_ods['ods_categoria'] == categoria])
            print(f"  {categoria}: {count} ODS")
    
    if 'ods_status' in df_ods.columns:
        print(f"\nODS por status:")
        for status in sorted(df_ods['ods_status'].unique()):
            count = len(df_ods[df_ods['ods_status'] == status])
            print(f"  {status}: {count} ODS")
    
    # Mostrar lista dos ODS (excluindo registro SK=0)
    df_stats = df_ods[df_ods['ods_sk'] != 0]
    if len(df_stats) > 0:
        print(f"\nüéØ Lista dos ODS:")
        for _, row in df_stats.iterrows():
            print(f"  {row['ods_codigo']}: {row['ods_nome']}")
    
    print(f"\n‚úÖ Processo conclu√≠do! Dimens√£o ODS criada com sucesso.")
    print("üí° A dimens√£o inclui os 17 Objetivos de Desenvolvimento Sustent√°vel da ONU organizados por categorias.")
    print("üîó Esta dimens√£o pode ser usada para an√°lises de alinhamento da pesquisa com os ODS.")